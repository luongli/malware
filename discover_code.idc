#include <idc.idc>

static decode_function(func_addr) {
    auto func, end, count, inst, inst_name, call_addr, op_name;
    auto subs_index, slen, unk_name, child_func;
    
    func = GetFunctionAttr(func_addr, FUNCATTR_START);
    
    if (func != -1) {
        end = GetFunctionAttr(func, FUNCATTR_END);
        count = 0;
        inst = func;
        
		// loop through each instruction of the function
        while (inst < end) {
            inst_name = GetMnem(inst);
            if (inst_name == "call") {
				// if the instruction is "call"
				// get the operand name and then check if the operand name contains unk_ string
                op_name = GetOpnd(inst, 0);
                subs_index = strstr(op_name, "unk_");
                if (subs_index != -1) {
					// if the operand name contains unk_ string
					// get the child function address and then make a function there
                    slen = strlen(op_name);
                    unk_name = substr(op_name, subs_index, slen);
                    child_func = LocByName(unk_name);
                    MakeFunction(child_func, -1);
                    decode_function(child_func);
                }
            }
            inst = FindCode(inst, SEARCH_DOWN | SEARCH_NEXT);
        }
        // check if the last instruction is ret
        if (inst_name != "retn" && inst_name != "ret") {
            Message("function may not finish at %x\n", inst);
        }
    } else {
        print("No instruction found\n");
    }
}

static main(){
    auto func_addr = 0x2001b0c5;
    decode_function(func_addr);
    Message("ok");
}
